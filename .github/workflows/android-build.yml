name: CI - Android Build

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main, develop]
    workflow_dispatch:

jobs:
    validate:
        runs-on: ubuntu-latest
        timeout-minutes: 5

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v2
              with:
                  version: 8

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "pnpm"

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: TypeScript type check
              run: pnpm run compile

            - name: ESLint check
              run: pnpm run lint

            - name: Validate Expo config
              run: npx expo config --type public

            - name: Validate Android project can be generated
              run: |
                  echo "Validating Android project structure..."
                  npx expo prebuild --platform android --clean --no-install
                  # Check that essential Android files exist
                  test -f android/app/build.gradle || exit 1
                  test -f android/build.gradle || exit 1
                  test -f android/app/src/main/AndroidManifest.xml || exit 1
                  echo "âœ“ Android project structure is valid"

    # TODO: Uncomment when you need full Android builds with code signing
    # build-android:
    #     runs-on: ubuntu-latest
    #     needs: validate
    #     steps:
    #         - name: Checkout code
    #           uses: actions/checkout@v4
    #         - name: Setup pnpm
    #           uses: pnpm/action-setup@v2
    #           with:
    #               version: 8
    #         - name: Setup Node.js
    #           uses: actions/setup-node@v4
    #           with:
    #               node-version: "20"
    #               cache: "pnpm"
    #         - name: Install dependencies
    #           run: pnpm install --frozen-lockfile
    #         - name: Setup Java
    #           uses: actions/setup-java@v4
    #           with:
    #               java-version: "17"
    #               distribution: "temurin"
    #         - name: Generate native Android project
    #           run: npx expo prebuild --platform android --clean
    #         - name: Make gradlew executable
    #           working-directory: android
    #           run: chmod +x ./gradlew
    #         - name: Build Android APK (Debug)
    #           working-directory: android
    #           run: ./gradlew assembleDebug
    #         - name: Build Android APK (Release - Requires Code Signing)
    #           working-directory: android
    #           env:
    #               KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
    #               KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
    #               KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
    #           run: |
    #               if [ -z "$KEYSTORE_PASSWORD" ] || [ -z "$KEY_ALIAS" ] || [ -z "$KEY_PASSWORD" ]; then
    #                 echo "Warning: Android signing secrets not configured, building unsigned release APK"
    #                 ./gradlew assembleRelease -Pandroid.injected.signing.store.file= -Pandroid.injected.signing.store.password= -Pandroid.injected.signing.key.alias= -Pandroid.injected.signing.key.password=
    #               else
    #                 ./gradlew assembleRelease
    #               fi
    #         - name: Upload APK artifacts
    #           uses: actions/upload-artifact@v4
    #           with:
    #               name: android-apk
    #               path: |
    #                   android/app/build/outputs/apk/debug/*.apk
    #                   android/app/build/outputs/apk/release/*.apk
    #               retention-days: 7

